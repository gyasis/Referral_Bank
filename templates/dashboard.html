<!doctype html>
<html lang="en" class="ms-0">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <title>Dashboard Template Â· Bootstrap v5.0</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <!-- Responsive DataTables CSS -->
  <link rel="stylesheet" type="text/css"
    href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css">
  <!-- Responsive DataTables JS -->
  <script type="text/javascript" src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js">
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
  <!-- Include jQuery Library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
  <!-- Include DataTables Library -->
  <script type="text/javascript" src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
</head>

<body>
  <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
    <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse"
      data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false"
      aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span>
    </button>
    <div id="title_T" class="col-md-3 h3 ms-3  text-white" data-pg-name="Title">Referral Bank</div>
    <input class="form-control form-control-dark w-100" type="text" placeholder="Search" aria-label="Search"
      id="search">
  </header>
  <!-- Initial Info Modal -->
  <div class="modal fade" id="initialInfoModal" tabindex="-1" aria-labelledby="initialInfoModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="initialInfoModalLabel">Welcome to a Referral App</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- You can add detailed information about the app here. For now, I'm just adding a placeholder. -->
          <div class="referral-bank-modal">
            <h3>Referral Bank</h3>
            <p>A web application for seamless management and retrieval of referral information.</p>
            <hr>

          </div>
        </div>
        <div class="modal-footer">
          <div class="container-fluid">
            <div class="row">
              <!-- Column for the "Got it!" button -->
              <div class="col text-center">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it!</button>
              </div>
              <!-- Column for the "Don't show me this again" button -->
              <div class="col text-center">
                <button id="dontShowAgainBtn" class="btn btn-secondary">Don't Show Again</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="main_info" class="container-fluid">
    <div class="row">
      <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
        <div class="position-sticky pt-3 bg-dark">
          <ul class="nav flex-column" id="specialties">
            {% for specialty in specialties %}
            <li class="nav-item"><a class="nav-link" href="#">{{ specialty }}</a>
            </li>
            {% endfor %}
          </ul>
        </div>
      </nav>
      <!-- Edit Modal -->
      <div class="modal fade" id="edit_modal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editModalLabel">Edit Record</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="edit_form">
                <!-- Name of Organization field -->
                <div class="mb-3">
                  <label for="NAME_OF_ORGANIZATION" class="form-label">Name of Organization</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="NAME_OF_ORGANIZATION" name="NAME_OF_ORGANIZATION"><span
                      class="input-group-text" id="search-icon-NAME_OF_ORGANIZATION"><i class="fa fa-plus"></i></span>
                  </div>
                </div>
                <!-- Name field -->
                <div class="mb-3">
                  <label for="NAME" class="form-label">Name</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="NAME" name="NAME"><span class="input-group-text"
                      id="search-icon-NAME"><i class="fa fa-plus"></i></span>
                  </div>
                </div>
                <!-- Location(s) field -->
                <div class="mb-3">
                  <label for="LOCATION" class="form-label">Location</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="LOCATION" name="LOCATION"><span class="input-group-text"
                      id="search-icon-LOCATION"><i class="fa fa-plus"></i></span>
                  </div>
                </div>
                <!-- Phone Number field -->
                <div class="mb-3">
                  <label for="PHONE_NUMBER" class="form-label">Phone Number</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="PHONE_NUMBER" name="PHONE_NUMBER"><span
                      class="input-group-text" id="search-icon-PHONE_NUMBER"><i class="fa fa-plus"></i></span>
                  </div>
                </div>
                <!-- Fax Number field -->
                <div class="mb-3">
                  <label for="FAX_NUMBER" class="form-label">Fax Number</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="FAX_NUMBER" name="FAX_NUMBER"><span
                      class="input-group-text" id="search-icon-FAX_NUMBER"><i class="fa fa-plus"></i></span>
                  </div>
                </div>
                <!-- Website field -->
                <div class="mb-3">
                  <label for="WEBSITE" class="form-label">Website</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="WEBSITE" name="WEBSITE"><span class="input-group-text"
                      id="search-icon-WEBSITE"><i class="fa fa-plus"></i></span>
                  </div>
                </div>
                <!-- Email field -->
                <div class="mb-3">
                  <label for="EMAIL" class="form-label">Email</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="EMAIL" name="EMAIL"><span class="input-group-text"
                      id="search-icon-EMAIL"><i class="fa fa-plus"></i></span>
                  </div>
                </div>
                <!-- Notes field -->
                <div class="mb-3">
                  <label for="NOTES" class="form-label">Notes</label>
                  <div class="input-group">
                    <textarea class="form-control" id="NOTES" name="NOTES"></textarea><span class="input-group-text"
                      id="search-icon-NOTES"><i class="fa fa-plus"></i></span>
                  </div>
                </div>
                <!-- Specialty field -->
                <div class="mb-3">
                  <label for="SPECIALTY" class="form-label">Specialty</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="SPECIALTY" name="SPECIALTY"><span
                      class="input-group-text" id="search-icon-SPECIALTY"><i class="fa fa-plus"></i></span>
                  </div>
                </div>
                <!-- Search Results Display -->
                <div id="search-results" style="display:none;">
                  <h5>Search Results:</h5>
                  <ul id="results-list">
                    <!-- Results will be populated here -->
                  </ul>
                </div>
                <!-- Output Display -->
                <div id="output-display" style="display:none; height:200px; overflow-y:scroll;">
                  <h5>Output:</h5>
                  <pre id="output-content">
                          <!-- Output will be populated here -->
                      </pre>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="submit" class="btn btn-primary" id="update_button">Update</button>
                  <button id="addAllButton" class="btn btn-primary">Add All</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <main class="col-md-9 col-lg-7 px-md-4 main">
        <h2> <button id="addReferral" class="btn btn-success ms-3">Add New Referral</button> </h2>
        <div class="table-responsive" id="table_results">
          <!-- Table gets populated here -->
        </div>
        <div class="card" id="card_display" style="display: none;">
          <div class="card-body">
            <div class="row">
              <!-- This column contains the card details -->
              <div class="col-md-10">
                <h5 class="card-title">Card title</h5>
                <p class="card-text">Some quick example text to build on the card title and make up the bulk of the
                  card's content.</p>
              </div>
              <!-- This column contains the edit and delete icons -->
              <div class="col-md-2 text-end"><span class="icon-container"> <a href="#" id="record_edit" title="Edit"> <i
                      class="fa fa-edit fa-lg edit-icon" aria-hidden="true"></i> </a> </span><span
                  class="icon-container"> <a href="#" id="record_delete" title="Delete"> <i
                      class="fa fa-trash fa-lg delete-icon" aria-hidden="true"></i> </a> </span>
              </div>
            </div>
          </div>
        </div>
        <div class="card" id="card_display" style="display: none;">
          <div class="card-body">
            <div class="row">
              <!-- This column contains the card details -->
              <div class="col-md-10">
                <h5 class="card-title">Card title</h5>
                <p class="card-text">Some quick example text to build on the card title and make up the bulk of the
                  card's content.</p>
              </div>
              <!-- This column contains the edit and delete icons -->
              <div class="col-md-2 text-end"><span class="icon-container"> <a href="#" id="record_edit" title="Edit"> <i
                      class="fa fa-edit fa-2x edit-icon" aria-hidden="true"></i> </a> </span><span
                  class="icon-container"> <a href="#" id="record_delete" title="Delete"> <i
                      class="fa fa-trash fa-2x delete-icon" aria-hidden="true"></i> </a> </span>
              </div>
            </div>
          </div>
        </div>
        <!-- Provider information display -->
        <div class="card" id="provider_display" style="display: none;">
          <div class="card-body">
            <h5 class="card-title">Provider Information</h5>
            <p class="card-text">Provider details will be shown here.</p>
          </div>
        </div>
        <!-- Comments Section -->
        <div class="comments-section mt-4" style="display: none;">
          <h5>Comments</h5>
          <div class="comments-list">
            <!-- Sample Comment -->
            <div class="comment">
              <div class="comment-header"><span class="comment-user">User Name</span><span
                  class="comment-timestamp">Timestamp</span><span class="comment-actions"> <a href="#"
                    class="comment-edit">Edit</a> <a href="#" class="comment-delete">Delete</a> </span>
              </div>
              <div class="comment-body">
                This is a sample comment.
              </div>
            </div>
          </div>
          <div class="add_comment">
            <textarea placeholder="Add a comment..."></textarea>
            <div></div>
            <button class="btn btn-primary mt-2 add_comment button">Post Comment</button>
          </div>
        </div>
      </main>
      <div class="col-lg-auto col-md-auto col-xl-auto col-xxl-auto ms-auto">
        <h3><button id="loginButton" class="btn btn-primary">Login</button>
        </h3>
      </div>
    </div>
  </div>
  <!-- Login & Register Modal -->
  <div class="modal fade" id="loginRegisterModal" tabindex="-1" aria-labelledby="loginRegisterModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginRegisterModalLabel">Login / Register</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <!-- Tab Navigation -->
          <ul class="nav nav-tabs" id="loginRegisterTab" role="tablist">
            <li class="nav-item" role="presentation">
              <a class="nav-link active" id="login-tab" data-bs-toggle="tab" href="#login" role="tab">Login</a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="register-tab" data-bs-toggle="tab" href="#register" role="tab">Register</a>
            </li>
          </ul>

          <!-- Tab Content -->
          <div class="tab-content" id="loginRegisterTabContent">
            <!-- Login Form -->
            <div class="tab-pane fade show active" id="login" role="tabpanel">
              <form id="loginForm">
                <div class="mb-3">
                  <label for="loginEmail" class="form-label">Email address</label>
                  <input type="email" class="form-control" id="loginEmail" name="email" required>
                </div>
                <div class="mb-3">
                  <label for="loginPassword" class="form-label">Password</label>
                  <input type="password" class="form-control" id="loginPassword" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
              </form>
            </div>
            <!-- Registration Form -->
            <div class="tab-pane fade" id="register" role="tabpanel">
              <form id="registerForm">
                <div class="mb-3">
                  <label for="registerUsername" class="form-label">Username</label>
                  <input type="text" class="form-control" id="registerUsername" name="username" required>
                </div>
                <div class="mb-3">
                  <label for="registerEmail" class="form-label">Email address</label>
                  <input type="email" class="form-control" id="registerEmail" name="email" required>
                </div>
                <div class="mb-3">
                  <label for="registerPassword" class="form-label">Password</label>
                  <input type="password" class="form-control" id="registerPassword" name="password" required>
                  <input type="hidden" id="updatePasswordFlag" name="updatePasswordFlag" value="false">

                </div>
                <button type="submit" class="btn btn-success">Register</button>
              </form>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous">
  </script>
  <script>
    var currentlyEditingIndex = null;


    $(document).ready(function () {
      // Check if the modal has been shown before
      if (!localStorage.getItem('modalShown')) {
        $('#initialInfoModal').modal('show');
      }
      // When the "Don't show me this again" button is clicked
      $('#dontShowAgainBtn').on('click', function () {
        localStorage.setItem('modalShown', 'true');
        $('#initialInfoModal').modal('hide'); // this will close the modal
      });


      var table;


      // This is the function definition for printing the table
      function printTableToConsole() {
        var tableData = [];
        $('#table_results table tbody tr').each(function (rowIndex, tr) {
          var row = [];
          $(this).find('td').each(function (colIndex, td) {
            row.push($(td).text().trim());
          });
          tableData.push(row);
        });

        // Printing headers (assuming they exist in the table)
        var headers = [];
        $('#table_results table thead tr th').each(function (index, th) {
          headers.push($(th).text().trim());
        });

        console.table(headers);
        console.table(tableData);
      }


      function createTable(data) {
        $("#table_results").html(data);
        if ($.fn.DataTable.isDataTable('#table_results table')) {
          $('#table_results table')
            .DataTable()
            .destroy();
        }
        table = $('#table_results table').DataTable({
          searching: false,
          lengthChange: false,
          responsive: true,
          autoWidth: true
        });
        // Resize DataTable columns when the window is resized
        $(window).resize(function () {
          table
            .columns
            .adjust()
            .draw();
        });

        printTableToConsole();
      }

      $("#search").on('input', function () {
        var searchTerm = $(this).val();
        if (searchTerm.length > 2) {
          $
            .get("/search", {
              q: searchTerm
            }, function (data) {
              createTable(data);
            })
            .fail(function (jqXHR, textStatus, errorThrown) {
              console.error("Error during search: ", textStatus, ", ", errorThrown);
            });
        }
      });

      $('#table_results').on('click', 'table tbody tr', function () {
        const rowId = $(this).find('td:first').text(); // Getting the text from the first cell
        console.log("Clicked Row ID:", rowId);
        currentlyEditingIndex = rowId;
        $('table tbody tr').removeClass('highlight');
        $(this).addClass('highlight');

        $.get("/details", {
            index: rowId // Send the database id to the backend
          })
          .done(function (data) {
            function addRow(label, value) {
              return `
        <div class="row-container">
            <div class="label">${label}</div>
            <div class="value">${value}</div>
        </div>
    `;
            }

            // Check if a value is empty or 'not available'
            function isInvalidValue(value) {
              return !value || value === 'not available';
            }

            var combinedName = "";

            if (!isInvalidValue(data['NAME_OF_ORGANIZATION']) && !isInvalidValue(data['NAME'])) {
              combinedName = data['NAME_OF_ORGANIZATION'] + ' - ' + data['NAME'];
            } else if (!isInvalidValue(data['NAME_OF_ORGANIZATION'])) {
              combinedName = data['NAME_OF_ORGANIZATION'];
            } else if (!isInvalidValue(data['NAME'])) {
              combinedName = data['NAME'];
            } else {
              combinedName = "Information not available"; // Placeholder message, can be adjusted
            }

            $("#card_display .card-title").html(combinedName + '<br>');

            $("#card_display .card-text").html('');
            const fields = {
              'NAME': '<b>Recommended Provider</b>',
              'LOCATION': '<b>Location</b>',
              'PHONE_NUMBER': '<b>Phone Number</b>',
              'FAX_NUMBER': '<b>Fax Number</b>',
              'WEBSITE': '<b>Website</b>',
              'EMAIL': '<b>Email</b>',
              'NOTES': '<b>Notes</b>',
              'SPECIALTY': '<b>Specialty</b>' // Add more fields as needed.
            };
            for (let key in fields) {
              if (data[key] && data[key] !== 'nan' && data[key] !== 'not available') {
                let value = key === 'WEBSITE' ?
                  `<a href="${data[key]}">${data[key]}</a>` :
                  data[key];
                $("#card_display .card-text").append(addRow(fields[key], value));
              }
            }

            $("#card_display").show();

            // Show the comments section when the provider card is displayed
            $(".comments-section").show();
          })
          .fail(function (jqXHR, textStatus, errorThrown) {
            console.error("Error: ", textStatus, ", ", errorThrown);
          });
      });



      // When the edit icon on the card is clicked
      $('#card_display').on('click', '.fa-edit', function () {
        $.get("/details", {
          index: currentlyEditingIndex
        }).done(function (data) {
          // Populate a form with the data, for example:
          $("#edit_form input[name='NAME_OF_ORGANIZATION']").val(data['NAME_OF_ORGANIZATION']);
          $("#edit_form input[name='NAME']").val(data['NAME']);
          $("#edit_form input[name='LOCATION']").val(data['LOCATION']);
          $("#edit_form input[name='PHONE_NUMBER']").val(data['PHONE_NUMBER']);
          $("#edit_form input[name='FAX_NUMBER']").val(data['FAX_NUMBER']);
          $("#edit_form input[name='WEBSITE']").val(data['WEBSITE']);
          $("#edit_form input[name='EMAIL']").val(data['EMAIL']);
          $("#edit_form textarea[name='NOTES']").val(data['NOTES']);
          $("#edit_form input[name='SPECIALTY']").val(data[
            'SPECIALTY']); // Add this line// Assuming NOTES is a textarea
          // ... and so on for other fields ...

          // Show the edit modal
          $("#edit_modal").modal('show');
        });
      });
      // When the edit form is submitted
      $('#edit_form').on('submit', function (e) {
        e.preventDefault();
        var formData = $(this).serialize();

        if (currentlyEditingIndex !== null) {
          formData += "&index=" + currentlyEditingIndex;
        }
        console.log("Submitting form data:", formData);
        $.post("/update", formData).done(function (data) {
          var searchTerm = $("#search").val();
          if (searchTerm.length > 2) {
            $.get("/search", {
              q: searchTerm
            }, function (updatedData) {
              createTable(updatedData);
            });
          }
          // Close the modal after 1 second
          setTimeout(function () {
            $("#edit_modal").modal('hide');
          }, 100); // Waits for 1 second (1000 milliseconds)
        }).fail(function (jqXHR, textStatus, errorThrown) {
          console.error("Error during save: ", textStatus, ", ", errorThrown);
        });
      });

      // When the delete icon on the card is clicked
      $('#card_display').on('click', '.fa-trash', function () {
        if (confirm("Are you sure you want to delete this record?")) {
          $.post("/delete", {
              index: currentlyEditingIndex
            })
            .done(function (data) {
              // Assuming the backend responds with a success message
              alert(data.message);

              // Hiding the card after deletion
              $("#card_display").hide();

              // Hide the comments section when the provider card is hidden
              $(".comments-section").hide();

              // You might also want to refresh any related data displays.
              // For instance, if there's a table displaying these records, you might want to refresh it.
            })
            .fail(function (jqXHR, textStatus, errorThrown) {
              console.error("Error during delete: ", textStatus, ", ", errorThrown);
              alert("Failed to delete the record.");
            });
        }
      });


      $("#specialties .nav-link").on('click', function () {
        $("#card_display").hide();
        $(".comments-section").hide();
        var specialty = $(this).text();
        $.get("/filter", {
          q: specialty
        }, function (data) {
          createTable(data);
        });
      });



      $("#addReferral").click(function () {
        $("#edit_form").trigger('reset');
        $("#update_button").text('Add');
        currentlyEditingIndex = null; // Reset the index for add
        $("#update_button").data('action', 'add');
        $("#edit_modal").modal('show');
      });
    });
  </script>
  <script>
    $("#search-icon-NAME_OF_ORGANIZATION").click(function () {
      // Call the smart search function for the NAME_OF_ORGANIZATION field
      var results = search_and_parse({
        "NAME_OF_ORGANIZATION": "not available"
      });
      // Display the results to the user
    });

    $("#search-icon-NAME").click(function () {
      var results = search_and_parse({
        "NAME": "not available"
      });
      // Display the results to the user
    });

    $("#search-icon-LOCATION").click(function () {
      var results = search_and_parse({
        "LOCATION": "not available"
      });
      // Display the results to the user
    });

    $("#search-icon-PHONE_NUMBER").click(function () {
      var results = search_and_parse({
        "PHONE_NUMBER": "not available"
      });
      // Display the results to the user
    });

    $("#search-icon-FAX_NUMBER").click(function () {
      var results = search_and_parse({
        "FAX_NUMBER": "not available"
      });
      // Display the results to the user
    });

    $("#search-icon-WEBSITE").click(function () {
      var results = search_and_parse({
        "WEBSITE": "not available"
      });
      // Display the results to the user
    });

    $("#search-icon-EMAIL").click(function () {
      var results = search_and_parse({
        "EMAIL": "not available"
      });
      // Display the results to the user
    });

    $("#search-icon-NOTES").click(function () {
      var results = search_and_parse({
        "NOTES": "not available"
      });
      // Display the results to the user
    });

    $("#search-icon-SPECIALTY").click(function () {
      var results = search_and_parse({
        "SPECIALTY": "not available"
      });
      // Display the results to the user
    });
  </script>
  <script>
    // Function to display search results
    function displaySearchResults(results) {
      var resultsList = $("#results-list");
      resultsList.empty(); // Clear previous results

      results.forEach(function (result, index) {
        var listItem = $("<li></li>").text(result);
        var plusIcon = $("<i class='fa fa-plus'></i>").click(function () {
          // Populate the corresponding field in the form
          $("#edit_form input[name='" + index + "']").val(result);
        });
        listItem.append(plusIcon);
        resultsList.append(listItem);
      });

      $("#search-results").show();
    }

    // Function to display output
    function displayOutput(output) {
      $("#output-content").text(output);
      $("#output-display").show();
    }

    // Sample usage:
    // Assuming 'results' is the data you get from the search_and_parse function
    // displaySearchResults(results);

    // Assuming 'output' is the string you want to display from the print statements
    // displayOutput(output);
  </script>
  <script>
    // Assuming 'results' is an object containing the details you fetched from the search

    // Event listener for the plus icon next to the NAME_OF_ORGANIZATION result
    $("#search-icon-NAME_OF_ORGANIZATION").click(function () {
      $("#NAME_OF_ORGANIZATION").val(results["NAME_OF_ORGANIZATION"]);
    });

    // Repeat the above for each field in your form:
    $("#search-icon-NAME").click(function () {
      $("#NAME").val(results["NAME"]);
    });

    $("#search-icon-LOCATION").click(function () {
      $("#LOCATION").val(results["LOCATION"]);
    });

    $("#search-icon-PHONE_NUMBER").click(function () {
      $("#PHONE_NUMBER").val(results["PHONE_NUMBER"]);
    });

    $("#search-icon-FAX_NUMBER").click(function () {
      $("#FAX_NUMBER").val(results["FAX_NUMBER"]);
    });

    $("#search-icon-WEBSITE").click(function () {
      $("#WEBSITE").val(results["WEBSITE"]);
    });

    $("#search-icon-EMAIL").click(function () {
      $("#EMAIL").val(results["EMAIL"]);
    });

    $("#search-icon-NOTES").click(function () {
      $("#NOTES").val(results["NOTES"]);
    });

    $("#search-icon-SPECIALTY").click(function () {
      $("#SPECIALTY").val(results["SPECIALTY"]);
    });

    // ... and so on for other fields ...
  </script>
  <script>
    $("#addAllButton").click(function () {
      // Call the smart search function for all fields
      var results = search_and_parse({
        "NAME_OF_ORGANIZATION": "not available",
        "NAME": "not available",
        // ... add other fields ...
      });

      // Loop through each input field in the modal
      $(".modal input").each(function () {
        var $input = $(this); // Current input field
        var fieldId = $input.attr('id');

        // If the field is empty and the result exists for this field
        if ($input.val() === "" && results[fieldId]) {
          // Create a confirmation dialog
          $("<div></div>")
            .html("Suggested value for " + fieldId + ": " + results[fieldId] +
              ".<br>Do you want to update this field?")
            .dialog({
              modal: true,
              title: "Suggestion for " + fieldId,
              buttons: {
                "Accept": function () {
                  $input.val(results[fieldId]);
                  $(this).dialog("close");
                },
                "Ignore": function () {
                  $(this).dialog("close");
                }
              }
            });
        }
      });
    });
  </script>
  <script>
    $(document).ready(function () {

      // Function to fetch and display comments for a specific record
      function loadCommentsForRecord(recordId) {
        $.get("/comments", {
          recordId: recordId
        }, function (data) {
          $(".comments-list").empty(); // Clear existing comments
          var currentUser = data.current_user; // This is the logged-in user's username or user_id

          data.comments.forEach(function (comment) {
            console.log("Comments:", data.comments);
            console.log(comment);

            var commentActions = ''; // Default to empty

            // If the comment was made by the logged-in user, show edit and delete links
            if (comment.username === currentUser) { // Change to user_id if using user ids
              commentActions = `
                    <a href="#" class="comment-edit" data-id="${comment.id}">Edit</a>
                    <a href="#" class="comment-delete" data-id="${comment.id}">Delete</a>
                `;
            }

            var commentHTML = `
                        <div class="comment">
                            <div class="comment-header">
                                <span class="comment-user">${comment.username}</span>
                                <span class="comment-timestamp">${comment.timestamp}</span>
                                <span class="comment-actions">
                                    ${commentActions}
                                </span>
                            </div>
                            <div class="comment-body">
                                ${comment.comment}
                            </div>
                        </div>
                    `;
            $(".comments-list").append(commentHTML);
          });
        });
      }

      // When a record is clicked
      $('#table_results').on('click', 'table tbody tr', function () {
        // Load comments for the clicked record
        loadCommentsForRecord(currentlyEditingIndex);
      });

      // When posting a new comment
      $(".add_comment button").click(function () {
        var commentText = $(".add_comment textarea").val().trim();

        // Check if the commentText is empty
        if (!commentText) {
          alert("Please enter a comment before posting.");
          return; // Exit the function early
        }


        if (commentText) {
          $.post("/add_comment", {
            text: commentText,
            recordId: currentlyEditingIndex // Send the record ID to the server
          }, function (response) {
            if (response.status === "success") {
              var newComment = `
                            <div class="comment">
                                <div class="comment-header">
                                    <span class="comment-user">${response.username}</span>
                                    <span class="comment-timestamp">${response.timestamp}</span>
                                    <span class="comment-actions">
                                        <a href="#" class="comment-edit" data-id="${response.commentId}">Edit</a>
                                        <a href="#" class="comment-delete" data-id="${response.commentId}">Delete</a>
                                    </span>
                                </div>
                                <div class="comment-body">
                                    ${response.commentText}
                                </div>
                            </div>
                        `;
              $(".comments-list").append(newComment);
              $(".add_comment textarea").val(''); // Clear the textarea

              // After successfully posting a comment, reload the comments for the current record
              loadCommentsForRecord(currentlyEditingIndex);
            } else {
              console.error("Failed to post comment. Response:", response);
              alert("Failed to post comment.");
            }
          }).fail(function (jqXHR, textStatus, errorThrown) {
            console.error("Error during comment post request:", textStatus, errorThrown);
            alert("Failed to post comment due to a server error.");
          });
        } else {
          alert("Please enter a comment before posting.");
        }
      });

      // Edit and delete comment functionality
      $(".comments-list").on("click", ".comment-edit", function (e) {
        e.preventDefault();
        var commentId = $(this).data("id");
        var commentText = $(this).closest(".comment").find(".comment-body").text();

        // Display the comment in a textarea for editing
        var editTextarea = $('<textarea></textarea>').val(commentText);
        var saveButton = $('<button>Save</button>');

        saveButton.on('click', function () {
          var updatedText = editTextarea.val();

          // Send the updated comment to the server
          $.post("/edit_comment", {
            comment_id: commentId,
            updated_text: updatedText
          }, function (response) {
            if (response.status === "success") {
              // Update the comment display
              $(`[data-id="${commentId}"]`).closest(".comment").find(".comment-body").text(updatedText);
              toastr.success(response.message);
            } else {
              toastr.error(response.message);
            }
          }).fail(function () {
            toastr.error("Failed to update comment due to a server error.");
          });
        });

        // Replace the comment text with the textarea and save button
        $(this).closest(".comment").find(".comment-body").empty().append(editTextarea).append(saveButton);
      });

      // Add the Dmment functionality here
      $(".comments-list").on("click", ".comment-delete", function (e) {
        e.preventDefault();
        var commentId = $(this).data("id");
        $.post("/delete_comment", {
          comment_id: commentId
        }, function (response) {
          if (response.status === "success") {
            // Remove the comment from the list
            $(`[data-id="${commentId}"]`).closest(".comment").remove();
            toastr.success(response.message);
          } else {
            toastr.error(response.message);
          }
        }).fail(function () {
          toastr.error("Failed to delete comment due to a server error.");
        });
      });

    });
  </script>
  <script>
    toastr.options = {
      "closeButton": true,
      "debug": false,
      "newestOnTop": false,
      "progressBar": true,
      "positionClass": "toast-bottom-right",
      "preventDuplicates": false,
      "showDuration": "300",
      "hideDuration": "1000",
      "timeOut": "10000", // The notification will close after 10 seconds
      "extendedTimeOut": "1000",
      "showEasing": "swing",
      "hideEasing": "linear",
      "showMethod": "fadeIn",
      "hideMethod": "fadeOut"
    };

    // Play a notification sound
    var audio = new Audio('https://example.com/notification_sound.mp3');
    audio.play();

    toastr.info(
      '<br><strong>Current Records safe!!</strong><br>Soon, this app will be migrating to a new web address. For record entry contact @GyasiSutton on Teams.<br>Commenting coming soon',
      'Version 0.21 Released - Prepare for Address Migration');
  </script>
  
<script>
    $("#registerForm").submit(function (e) {
      e.preventDefault();
      var formData = $(this).serialize();

      $.ajax({
        type: "POST",
        url: "/register",
        data: formData,
        dataType: "json",
        success: function (response) {
          if (response.status == "success") {
            if(response.action == "passwordUpdated") {
              // If password was updated, attempt to login with the new credentials
              $.ajax({
                type: "POST",
                url: "/login",
                data: {
                  email: $("#registerEmail").val(),
                  password: $("#registerPassword").val()
                },
                dataType: "json",
                success: function (loginResponse) {
                  if (loginResponse.status == "success") {
                    $("#registerModal").modal('hide');
                    var audio = new Audio('https://example.com/notification_sound.mp3');
                    audio.play();
                    toastr.success(loginResponse.message, 'Login');
                    location.reload();
                  }
                }
              });
            } else {
              var audio = new Audio('https://example.com/notification_sound.mp3');
              audio.play();
              toastr.success(response.message, 'Registration');
              
              // Switch to the login tab after a successful registration
              $('#loginRegisterTab a[href="#login"]').tab('show');
            }
          } else {
            toastr.error(response.message, 'Registration Failed');
          }
        },
        error: function () {
          toastr.error('An error occurred while processing your request.', 'Registration Failed');
        }
      });
    });

    $("#loginForm").submit(function (e) {
      e.preventDefault();
      var formData = $(this).serialize();

      $.ajax({
        type: "POST",
        url: "/login",
        data: formData,
        dataType: "json",
        success: function (response) {
          if (response.status == "success") {
            var audio = new Audio('https://example.com/notification_sound.mp3');
            audio.play();

            toastr.success(response.message, 'Login');

            if (response.generic_password_used) {
              switchToRegisterTab(response.username, response.email);
            } else {
              location.reload();
            }
          } else {
            toastr.error(response.message, 'Login Failed');
          }
        },
        error: function () {
          toastr.error('An error occurred while processing your request.', 'Login Failed');
        }
      });
    });

    function switchToRegisterTab(username, email) {
      $('#loginRegisterTab a[href="#register"]').tab('show');
      $("#registerUsername").val(username).prop("readonly", true);
      $("#registerEmail").val(email).prop("readonly", true);
      $("#updatePasswordFlag").val("true");
      $("#registerPassword").attr("placeholder", "CHANGE PASSWORD").focus();
    }

    $(document).ready(function () {
      $.ajax({
        type: "GET",
        url: "/is_logged_in",
        dataType: "json",
        success: function (response) {
          if (response.logged_in) {
            $("#loginButton").hide();
          } else {
            $("#loginButton").show();
          }
        }
      });

      $("#loginButton").click(function () {
        $("#loginRegisterModal").modal('show');
      });
    });
</script>


</body>

</html>
